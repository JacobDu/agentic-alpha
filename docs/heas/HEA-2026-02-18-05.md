# HEA-2026-02-18-05

## 1) hea_round
- hea_round: HEA-2026-02-18-05
- date: 2026-02-18
- owner: agent

## 2) hypothesis
- hypothesis: 从因子库中按 |RankICIR| 排名选取 Top-N 因子（N=20/30/50/80），仅用这些因子训练 LightGBM 模型，通过因子精选实现更优的信号效率和组合收益
- market_logic: 因子数量过多会引入噪声和冗余，精选 Top-N 因子可减少过拟合，提高模型泛化能力。经验速记 #4 表明 TopN50 在 CSI1000 上曾超越 158 因子基线
- expected_direction: TopN 模型在组合收益上优于 Alpha158 全量基线

## 3) factor_expression_list
- 因子来源: factor_library.db 中 csi1000 市场按 |rank_icir| 降序排名
- 去重规则: 排除 VSUMP/VSUMN（与 VSUMD 信息重复）
- TopN20: 前 20 因子（以 COMP_TRIPLE_TQ_CV_GAP 为首）
- TopN30: 前 30 因子
- TopN50: 前 50 因子
- TopN80: 前 80 因子
- Baseline: Alpha158 全量 158 因子

## 4) preflight_gate
- parse_ok: pass (DBTopN handler 从 DB 加载表达式，全部可解析)
- complexity_level: high (5 个模型 × LightGBM 训练 + 回测)
- redundancy_flag: medium (TopN 按 ICIR 排序，未显式去相关，高 ICIR 因子间可能存在冗余)
- data_availability: pass (所有因子表达式基于已有量价估值字段)
- gate_notes: DBTopN handler 不继承 Alpha158 全量，仅加载 DB 中的 Top-N 因子

## 5) experiment_config
- script: scripts/run_topn_comparison.py
- handler: project_qlib.factors.topn_db.DBTopN{20,30,50,80}
- market: csi1000
- start: 2018-01-01
- end: 2024-12-31
- segments:
  - train: 2018-01-01 ~ 2022-12-31
  - valid: 2023-01-01 ~ 2023-12-31
  - test: 2024-01-01 ~ 2024-12-31
- model: LGBModel (loss=mse, lr=0.05, max_depth=8, num_leaves=128, n_estimators=1000, early_stopping=50)
- backtest: TopkDropoutStrategy (topk=50, n_drop=5, open_cost=0.0005, close_cost=0.0015, account=100M)
- benchmark: SH000852
- run_id: N/A (standalone)
- output_paths:
  - outputs/topn_comparison.json
  - outputs/logs/topn_baseline_158.log
  - outputs/logs/topn_topn_20.log
  - outputs/logs/topn_topn_30.log
  - outputs/logs/topn_topn_50.log
  - outputs/logs/topn_topn_80.log

## 6) layer_a_single_factor
> Layer A 描述 LightGBM 模型的信号预测能力（模型层面 IC）

| 模型 | 特征数 | IC | ICIR | Rank IC | Rank ICIR | 训练时间 |
|------|--------|-----|------|---------|-----------|---------|
| baseline_158 | 158 | 0.0365 | 0.302 | 0.0238 | 0.177 | 56s |
| topn_20 | 20 | 0.0299 | 0.251 | 0.0265 | 0.202 | 29s |
| **topn_30** | **30** | **0.0346** | **0.275** | **0.0253** | **0.189** | **48s** |
| topn_50 | 50 | 0.0349 | 0.279 | 0.0286 | 0.227 | 71s |
| topn_80 | 80 | 0.0345 | 0.268 | 0.0313 | 0.232 | 79s |

### 信号分析:
- IC：baseline(0.0365) > topn_50(0.0349) > topn_30(0.0346) > topn_80(0.0345) > topn_20(0.0299)
- Rank IC：topn_80(0.0313) > topn_50(0.0286) > topn_20(0.0265) > topn_30(0.0253) > baseline(0.0238)
- Rank ICIR：topn_80(0.232) > topn_50(0.227) > topn_20(0.202) > topn_30(0.189) > baseline(0.177)
- **TopN 模型的 Rank IC 和 Rank ICIR 均优于 baseline**，说明精选因子提升了排序信号质量
- layer_a_result: pass (所有模型 IC > 0.02)

## 7) layer_b_portfolio
- executed: yes

| 模型 | 超额收益(无成本) | IR(无成本) | 回撤(无成本) | 超额收益(含成本) | IR(含成本) | 回撤(含成本) |
|------|-----------------|-----------|-------------|-----------------|-----------|-------------|
| baseline_158 | -7.56% | -0.529 | -14.3% | -11.86% | -0.831 | -16.3% |
| topn_20 | -4.93% | -0.425 | -10.7% | -9.47% | -0.817 | -12.3% |
| **topn_30** | **-0.16%** | **-0.016** | **-9.5%** | **-4.69%** | **-0.466** | **-10.5%** |
| topn_50 | -9.50% | -0.982 | -13.3% | -14.00% | -1.448 | -16.9% |
| topn_80 | -9.83% | -0.904 | -14.2% | -14.20% | -1.306 | -17.0% |

### 组合分析:
- **TopN30 是明确的最优模型**:
  - 无成本超额仅 -0.16% (几乎持平基准)
  - 含成本 IR = -0.466 (最优)
  - 最大回撤 -10.5% (最低)
  - 相比 baseline 改善: 超额收益 +7.17pp, IR +0.365, 回撤 +5.8pp
- TopN20 也优于 baseline（IR -0.817 vs -0.831）
- TopN50/80 反而劣于 baseline — **"因子诅咒"效应明显**：超过 30 个因子后引入噪声，导致组合退化
- 呈倒U形曲线：20 → 30 最优 → 50/80 退化

- layer_b_result: **fail** (所有模型含成本超额仍为负)

## 8) decision
- decision: Iterate
- decision_basis:
  1. Layer A pass：TopN 模型 Rank IC/ICIR 优于 baseline，信号质量有效
  2. Layer B fail：含成本超额仍为负，但 **TopN30 显著优于 baseline 和其他 TopN**
  3. TopN30 是最优选择（30 因子，IR=-0.466 vs baseline IR=-0.831，改善 44%）
  4. 20→30→50→80 呈倒U形，说明因子过多引入噪声
- failure_mode: 2024 CSI1000 市场不利 + TopK50 日度调仓策略次优。当前未使用双周调仓(hold=10)
- next_action:
  1. **双周调仓优化**：用 TopN30 因子 + hold=10 双周调仓重新回测（经验速记 #12 显示 IR 可从 1.21→1.61）
  2. **调整 TopK**：测试 TopK=30 减少持仓集中度
  3. **扩展测试期**：在 2021-2023 等区间验证 TopN30 的稳定性
  4. **因子去相关**：在选 TopN 时加入相关性过滤，可能进一步提升 TopN30→50 的表现

## 9) evidence_links
- db_query: `uv run python scripts/factor_db_cli.py list --market csi1000 --top 30`
- run_id: N/A (standalone)
- outputs:
  - outputs/topn_comparison.json
  - outputs/logs/topn_baseline_158.log
  - outputs/logs/topn_topn_20.log
  - outputs/logs/topn_topn_30.log
  - outputs/logs/topn_topn_50.log
  - outputs/logs/topn_topn_80.log
  - src/project_qlib/factors/topn_db.py
  - scripts/run_topn_comparison.py
